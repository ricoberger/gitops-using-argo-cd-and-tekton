# GitOps using Argo CD and Tekton

This repository demonstrates the GitOps workflow using [Argo CD](https://argoproj.github.io/projects/argo-cd) and [Tekton](https://tekton.dev). Argo CD is used to deploy our manifests to a Kubernetes cluster and Tekton is used for our CI/CD pipeline to build and update our applications.

In the first step we are creating a new Kubernetes cluster using Minikube and we enable the NGINX Ingress controller:

```sh
minikube start --driver=virtualbox --profile=dev
minikube addons enable ingress --profile=dev
```

In the next step we have to to install Argo CD by running the following command:

```sh
kustomize build clusters/argocd/dev | k apply -f -
```

After some minutes we have to verify that Argo CD is running:

```sh
kubectl get pods -n argocd
```

```txt
argocd-application-controller-75b4dcd7bb-97wm8   1/1     Running   0          3m50s
argocd-dex-server-996685b6d-zffmd                1/1     Running   0          3m50s
argocd-redis-99fb49846-pqn7p                     1/1     Running   0          3m50s
argocd-repo-server-5c76bd686b-79gjn              1/1     Running   0          3m49s
argocd-server-67885bdcff-5q5cz                   1/1     Running   0          3m49s
```

To deploy our manifests to the cluster we are using the **app of apps** pattern. For that we have to create a new `Application`, which manages all other applications (including Argo CD):

```sh
kubectl apply -f clusters/apps/dev.yaml
```

Now we have to add our Ingresses to the `/etc/hosts` file:

```sh
sudo echo "`minikube ip --profile=dev` argocd-dev.fake grafana-dev.fake prometheus-dev.fake" | sudo tee -a /etc/hosts
```

Now we can visit [argocd-dev.fake](https://argocd-dev.fake) and login with the default `admin` user. The initial password is autogenerated to be the pod name of the Argo CD API server. This can be retrieved with the command:

```sh
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

In the UI of Argo CD we can now see all deployed applications:

TODO: Screenshot
